<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <title>Editor</title>

    <link rel="stylesheet" href="./css/style.css" type="text/css">

    <link rel="stylesheet" href="./js/fileTree/css/jqueryFileTree.css" type="text/css">

    <link rel="stylesheet" href="./js/fileTree/css/filetree_ctools_ext.css" type="text/css">

    <script language="javascript" type="text/javascript" src="./js/lib/jquery.js"></script>

    <script language="javascript" type="text/javascript" src="./js/fileTree/js/jqueryFileTree.js"></script>

    <script language="javascript" type="text/javascript" src="./js/aceWrapper.js"></script>

    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/ace.js"></script>

    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-coffee.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-css.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-html.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-javascript.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-json.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-jsp.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-less.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-pgsql.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-properties.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-sql.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-svg.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-text.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-xml.js"></script>
    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/mode-xquery.js"></script>

    <script language="javascript" type="text/javascript" src="./js/lib/ace/src/theme-textmate.js"></script>
    <script language="javascript">

      var editor = new CodeEditor(),
          editorMode = "";
      // stores URL parameters
      var params = {};
      // stores currently opened file name
      var fileName = "";
      // stores currently opened file provider
      var fileProvider = "";
      // true if 'change' event was triggered, except when file is beeing loaded
      var isDirty = false;
      // if true isDirty will be set to true when 'change' events are triggered in the editor
      var pageLoaded = false;

      var listeners = {
        onStatusUpdate: null,
        onSave: null,
        notify: function(msg, type) { console.log(type + " : " + msg); }
      };

      var load = function(filename, provider) {

        editor.loadFile(
          filename,
          provider,
          function(response, loadedFileName, loadedFileProvider) {

            pageLoaded = false;

            // set filename in global var
            fileName = loadedFileName;

            // set file provider in global var
            fileProvider = loadedFileProvider;

            editor.setContents(response);

            pageLoaded = true;

            setDirty(false);

            // use menu selected mode or filename extension to set mode
            editor.setMode((!editorMode) ? loadedFileName.split('.').pop() : editorMode);

            notify('File ' + loadedFileName + ' loaded.');

            updateStatus();
          },
          function(response) {
            if(response) {
              if(typeof response.error == "function") {
                notify("Error loading file: " + response.error().statusText);
              } else {
                notify(response);
              }
            }
          }
        );
      };

      var save = function() {

        editor.saveFile(
          fileName, 
          fileProvider,
          function(response) {
            var msg = "";
            if(response && response.toString() === "true") {
              pageLoaded = true;
              setDirty(false);
              notify(fileName + ' saved.');
            } else {
              notify('Error saving file: ' + fileName, 'error');
            }
          },
          function(response) {
            notify(response, 'error');
          }
        );
      };

      var notifyType = {
        ERROR: 'error',
        INFO: 'info',
        WARN: 'warn'
      };
      var notify = function(msg, type) {
        if(type == null) {
          type = notifyType.INFO;
        }
        if(typeof(listeners.notify) == 'function') {
          listeners.notify(msg, type);
        }
      };

      var updateStatus = function() {
        var infoWarning = (editor.isReadOnly() && pageLoaded ? ' (readonly)' : '');
        // manage enable/disable save button
        var saveBtn = $("#saveBtn");
        if(isDirty && !editor.isReadOnly() ) {
          saveBtn.prop("disabled", false).css("cursor", "pointer").fadeTo(500, 1);

          infoWarning += '*';
        } else {
          saveBtn.prop("disabled", true).css("cursor", "default").fadeTo(500, 0.2);
        }

        var infoArea = $('#infoArea');
        if(fileName && fileName.length > 0) {
          infoArea.removeClass("disabled");
        } else {
          infoArea.addClass("disabled");
        }
        infoArea.text(fileName);

        $('#infoAreaWarnings').text(infoWarning);

        if(typeof(listeners.onStatusUpdate) == 'function') {
          listeners.onStatusUpdate(isDirty);
        }
      };
      
      var setDirty = function(dirty) {
        var wasDirty = isDirty;
        isDirty = dirty;

        if(isDirty != wasDirty) {
          if(!wasDirty && isDirty) {
            setExitNotification(true);
          } else if(wasDirty && !isDirty) {
            setExitNotification(false);
          }
          updateStatus();
        }
      };
      
      var setExitNotification= function(enable) {
        if(window.parent && window.parent != window) {//only mess with unload if owning the window
          return;
        }
        
        if(enable) {
          window.onbeforeunload = function(e) {
            return 'Any unsaved changes will be lost.';
          }
        } else {
          window.onbeforeunload = function() {null};
        }
      };
    </script>
  </head>
  <body>
    <table style="width: 100%;">
      <tbody>
        <tr>
          <td style="vertical-align: bottom; padding-right: 10px;">Available files:</td>
          <td>
            <div id="btnArea">
              <button id="saveBtn" onclick ="save()" style=""> Save </button>
              <span id="infoArea" style="min-width: 200px;"></span>
              <span id="infoAreaWarnings"></span>
              <span>&nbsp;mode:&nbsp;<select id="modes">
                <option value="" selected="selected">(auto detect)</option>
                <option value="coffee">Coffee</option>
                <option value="css">CSS</option>
                <option value="html">HTML</option>
                <option value="javascript">JavaScript</option>
                <option value="json">JSON</option>
                <option value="jsp">JSP</option>
                <option value="less">Less</option>
                <option value="pgsql">PGSQL</option>
                <option value="properties">Properties</option>
                <option value="sql">SQL</option>
                <option value="svg">SVG</option>
                <option value="text">Text</option>
                <option value="xml">XML</option>
                <option value="xquery">XQuery</option>
              </select></span>
            </div>
          </td>
        </tr>
        <tr>
          <td style="vertical-align: top; padding-right: 10px;">
            <div id="treeDivWrapper" style="width: 300px; float: left; height: 600px; margin-top: 12px;">
            </div>
          </td>
          <td style="vertical-align: top;">
            <pre style="height: 600px; width: 900px;" id="editArea"></pre>
          </td>
        </tr>
      </tbody>
    </table>

    <script>
      $(window).load(function() {
        // read url query parameters
        var queryParam,
            queryParams = window.location.search.substring(1),
            myRegex = /([^&=]+)=?([^&]*)/g;

        while((queryParam = myRegex.exec(queryParams)) !== null) {
          params[decodeURIComponent(queryParam[1])] = decodeURIComponent(queryParam[2]);
        }

        
        if(params.editorOnly) {
          $('#btnArea').css('display', 'none');
          $('#editArea').css('margin-top', 0);
          $('#editArea').css('margin-bottom', 0);
        }
        
        if(params.height) {
          $('#editArea').height(params.height);
        } else {
          $('#treeDivWrapper').height(window.innerHeight - (params.editorOnly ? 20 : 80));
          $('#editArea').height(window.innerHeight - (params.editorOnly ? 20 : 80));
        }
        
        if(params.width) {
          $('#editArea').width(params.width);
        } else{
          $('#treeDivWrapper').width(window.innerWidth - (window.innerWidth * 0.75) - 25);
          $('#editArea').width(window.innerWidth - (window.innerWidth * 0.25) - 25);
        }
            
        editor.initEditor('editArea');

        if(params.theme) {
          editor.setTheme(params.theme);
        }
        
        if(params.mode) {
          editor.setMode(params.mode);
        }

        editor.onChange(function(e) {
          //console.log(e.data.action);
          if(pageLoaded) {
            setDirty(true);
          }
        });

        // defaults settings
        $("#saveBtn").prop("disabled", true).css("cursor", "default").fadeTo(500, 0.2);
        editor.setReadOnly(true);
        if(params.path) {
          // More info, see aceWrapper.js
          load(params.path, params.provider);
        } else {
          fileName = "";//"Unsaved";
          updateStatus();
        }

      
        /********************
         **** FileTree ******
         ********************/

        editor.getProviders( function f( providers ){
          if( providers && providers.length > 0 ){
            for( i = 0; i < providers.length; i++ ){
              var providerId = providers[i].id;
              var providerName = providers[i].name;

              $divTree = $('<div id="treeDiv-' + providerId + '" provider-id="' + providerId + '"provider-name="' + providerName + '" class="urltargetfolderexplorer"></div>');

              $divTree.fileTree({
                root: "/",
                providerId: providerId,
                providerName: providerName,
                script: "/pentaho/plugin/cte/api/tree?showHiddenFiles=true&provider=" + providerId,
                expandSpeed: 500,
                collapseSpeed: 500,
                multiFolder: false,
                folderClick: function(obj, folder) {
                  if($(".selectedFolder").length > 0) {
                    $(".selectedFolder").attr("class", "");
                  }
                  $(obj).attr("class", "selectedFolder");
                }
              },
              function(file, provider) {
                if(!isDirty
                  || (isDirty && confirm("You have unsaved changes, discard them?"))) {

                  $(".selectedFile").attr("class", "");
                  $("a[rel='" + file + "']").attr("class", "selectedFile");

                  load("/" + file, provider);
                }
                
              });

              $('#treeDivWrapper').prepend( $divTree );
            }
          }
        });



        /**********************************
         **** editor mode select box ******
         **********************************/
        $("#modes")
          .change(function() {
            editorMode = $(this).val();
            // auto detect
            if(!editorMode) {
              editorMode = (!fileName) ? "" : fileName.split('.').pop();
            }
            editor.setMode(editorMode);
            notify("Requested editor mode: " + editorMode, 'info');
          });
      });

      $(window).resize(function() {
        $('#treeDivWrapper').height(window.innerHeight - (params.editorOnly ? 20 : 80));
        $('#editArea').height(window.innerHeight - (params.editorOnly ? 20 : 80));

        $('#treeDivWrapper').width(window.innerWidth - (window.innerWidth * 0.75) - 25);
        $('#editArea').width(window.innerWidth - (window.innerWidth * 0.25) - 25);
      });
    </script>
  </body>
</html>
