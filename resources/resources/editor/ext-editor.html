<!DOCTYPE html>
<html>
  <head>
    <style>
      #saveBtn{
        width: auto;
        border: solid 2px #bbb;
        height: 25px;
        font-size: 12px;
        padding: 3px 10px;
        background-color: #eaedee;
        color: #444;
      }

      #saveBtn:hover{
        background-color: #bbb;
        color: #444;
      }

      #infoArea{
        padding-left: 10px;
        padding-right: 10px;
        position: relative;
        font-size: 13px;
        font-weight: bold;
        color: #444;
        border: 1px solid #bbb;
        left: 10px;
      }

      body{
        color: #444;
        background-color: #eaedee;
      }
    
    </style>
    <meta charset="UTF-8"/>
    <title>Editor</title>

    <link rel="stylesheet" href="../static/fileTree/css/jqueryFileTree.css" type="text/css">

    <!--link rel="stylesheet" href="../static/jstree/themes/default/style.css" type="text/css"-->

    <script language="javascript" type="text/javascript" src="../static/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="../static/fileTree/js/jqueryFileTree.js"></script>
    <!--script language="javascript" type="text/javascript" src="../static/jstree/jstree.js"></script-->
    <script language="javascript" type="text/javascript" src="aceWrapper.js"></script>
    <script language="javascript" type="text/javascript" src="ace/src/ace.js"></script>
    <script language="javascript" type="text/javascript" src="ace/src/mode-javascript.js"></script>
    <script language="javascript" type="text/javascript" src="ace/src/mode-css.js"></script>
    <script language="javascript" type="text/javascript" src="ace/src/mode-xml.js"></script>
    <script language="javascript" type="text/javascript" src="ace/src/mode-html.js"></script>
    <!--script language="javascript" type="text/javascript" src="ace/src/theme-monokai.js"></script>
    <script language="javascript" type="text/javascript" src="ace/src/theme-twilight.js"></script>
    <script language="javascript" type="text/javascript" src="ace/src/theme-eclipse.js"></script-->
    <script language="javascript">

      var editor = new CodeEditor();
      // stores URL parameters
      var params = {};
      // stores currently opened file name
      var fileName = null;
      // true if 'change' event was triggered, except when file is beeing loaded
      var isDirty = false;
      // if true isDirty will be set to true when 'change' events are triggered in the editor
      var pageLoaded = false;

      var listeners = {
        onStatusUpdate: null,
        onSave: null,
        notify: null
      };
      
      var getUrlParams = function() {
        
        var url = document.location.href;
        var output = {};
        var index = url.indexOf('?');
        if(index < 0) {
          return null;
        } else {
          // First we get the part of the url with the parameters in it (i.e. after the '?'), and partition
          // it into individual 'var=value' pieces. Then we split those pieces and add them to the output object
          args = url.slice(index + 1).split('&');
          for(i = 0; i < args.length; i++) {
            pair = args[i].split('=');
            output[pair[0]] = unescape(pair[1]);
          }
          return output;
        }
      };
        

      var save = function() {
        editor.saveFile(
          fileName,
          editor.getContents(),
          function(result) {
            var msg = "";
            if(result.success) {
              setDirty(false);
              notify(result.result + ' saved ok.');
            } else {
              notify('error saving file: ' + result.result, 'error');
            }
          },
          function(data) {
            notify(data, 'error');
          }
        );
      };

      var notifyType = {
        ERROR: 'error',
        INFO: 'info',
        WARN: 'warn'
      };
      var notify = function(msg, type) {
        if(type == null) {
          type = notifyType.INFO;
        }
        if(typeof(listeners.notify) == 'function') {
          listeners.notify(msg,type);
        }
      };

      var updateStatus = function() {
       var info = fileName + (editor.isReadOnly() ? ' (readonly)' : '') + (isDirty ? '*' : '');
        $('#infoArea').text(info);
        if(typeof(listeners.onStatusUpdate) == 'function') {
          listeners.onStatusUpdate(isDirty);
        }
      };
      
      var setDirty = function(dirty) {
        var wasDirty = isDirty;
        isDirty = dirty;

        if(isDirty != wasDirty) {
          if(!wasDirty && isDirty) {
            setExitNotification(true);
          } else if(wasDirty && !isDirty) {
            setExitNotification(false);
          }
          updateStatus();
        }
      };
      
      var setExitNotification= function(enable) {
        if(window.parent && window.parent != window) {//only mess with unload if owning the window
          return;
        }
        
        if(enable) {
          window.onbeforeunload = function(e) {
            return 'Any unsaved changes will be lost.';
          }
        } else {
          window.onbeforeunload = function() {null};
        }
      };
    </script>
  </head>
  <body>
    <table style="width: 100%;">
      <tbody>
        <tr>
          <td style="padding-right: 10px;">Select file to edit:</td>
          <td>
            <div id="btnArea">
              <button id="saveBtn" onclick ="save()" style=""> Save </button>
              <span id="infoArea"/>
            </div>
          </td>
        </tr>
        <tr>
          <td style="vertical-align: top; padding-right: 10px;">
            <div id="browse_div" class="urltargetfolderexplorer" style="width: 300px; float: left; height: 600px; margin-top: 12px;"></div>
          </td>
          <td style="vertical-align: top;">
            <pre style="height: 600px; width: 900px;" id="editArea"></pre>
          </td>
        </tr>
      </tbody>
    </table>
        
</div>
    <script>
      window.onload = function() {
        params = getUrlParams();
        fileName = params.path;
        
        if(params.editorOnly) {
          $('#btnArea').css('display', 'none');
          $('#editArea').css('margin-top', 0);
          $('#editArea').css('margin-bottom', 0);
        }
        
        if(params.height) {
          $('#editArea').height(params.height);
        } else {
          $('#browse_div').height(window.innerHeight - (params.editorOnly ? 20 : 75));
          $('#editArea').height(window.innerHeight - (params.editorOnly ? 20 : 75));
        }
        
        if(params.width) {
          $('#editArea').width(params.width);
        } else{
          //$('#editArea').width(window.innerWidth - 30);
          //$('#browse_div').width($('#browse_div').parent().width() - 10);
          //$('#editArea').width($('#editArea').parent().width() - 10);
          $('#browse_div').width(window.innerWidth - (window.innerWidth * 0.75) - 15);
          $('#editArea').width(window.innerWidth - (window.innerWidth * 0.25) - 15);
        }
        
        if(fileName == null) {
          return;
        }
            
        editor.initEditor('editArea');

        if(params.theme) {
          editor.setTheme(params.theme);
        }
        
        if(params.mode) {
          editor.setMode(params.mode);
        }

        // More info, see aceWrapper.js
        editor.loadFile();
        updateStatus();

        editor.onChange(function(e) {
          //console.log(e.data.action);
          if(pageLoaded) {
            setDirty(true);
          }
        });
      
        /********************
         **** FileTree ******
         ********************/
        $('#browse_div').fileTree({
          root: "/",
          //script: "/pentaho/plugin/pentaho-cdf-dd/api/resources/explore?fileExtensions=" + extension + "&showHiddenFiles=true" + (fileName != "" ? "&dashboardPath=" + fileName : ""),
          script: "/pentaho/plugin/pentaho-cdf-dd/api/resources/explore?showHiddenFiles=true" + (fileName != "" ? "&dashboardPath=" + fileName : ""),
          expandSpeed: 1000,
          collapseSpeed: 1000,
          multiFolder: true,
          folderClick: function(obj, folder) {
            if($(".selectedFolder").length > 0) {
              $(".selectedFolder").attr("class", "");
            }
            $(obj).attr("class", "selectedFolder");
          }
        },
        function(file) {
          fileName = "/" + file;

          if(!isDirty
            || (isDirty && confirm("You have unsaved changes, discard them?"))) {

            $(".selectedFile").attr("class", "");
            $("a[rel='" + file + "']").attr("class", "selectedFile");

            editor.loadFile();
            updateStatus();
          }
          
        });
      };

      window.onresize = function() {
        $('#browse_div').height(window.innerHeight - (params.editorOnly ? 20 : 75));
        $('#editArea').height(window.innerHeight - (params.editorOnly ? 20 : 75));

        //$('#browse_div').width($('#browse_div').parent().width() - 10);
        //$('#editArea').width($('#editArea').parent().width() - 10);
        $('#browse_div').width(window.innerWidth - (window.innerWidth * 0.75) - 15);
        $('#editArea').width(window.innerWidth - (window.innerWidth * 0.25) - 15);

      };
    </script>
  </body>
</html>
